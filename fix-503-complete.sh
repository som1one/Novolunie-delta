#!/bin/bash

echo "üîß –ü–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ 503"
echo "================================="
echo ""

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd ~/novolunie || {
    echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ~/novolunie –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    exit 1
}

# –®–∞–≥ 1: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π Nginx, –µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω
echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ Nginx..."
if systemctl is-active --quiet nginx 2>/dev/null; then
    echo "‚ö†Ô∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π Nginx..."
    sudo systemctl stop nginx
    sudo systemctl disable nginx
    echo "‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–π Nginx –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    echo "‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–π Nginx –Ω–µ –∑–∞–ø—É—â–µ–Ω"
fi
echo ""

# –®–∞–≥ 2: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "2Ô∏è‚É£ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose down
echo ""

# –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Ä—Ç—ã —Å–≤–æ–±–æ–¥–Ω—ã
echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤..."
if sudo netstat -tulpn | grep -q ":80 "; then
    echo "‚ö†Ô∏è  –ü–æ—Ä—Ç 80 –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º:"
    sudo netstat -tulpn | grep ":80 "
    echo "–ü–æ–ø—ã—Ç–∫–∞ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–æ—Ä—Ç..."
    # –ù–∞–π–¥–µ–º PID –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–∞ –ø–æ—Ä—Ç—É 80
    PID=$(sudo lsof -t -i:80 2>/dev/null || sudo fuser 80/tcp 2>/dev/null | awk '{print $2}')
    if [ ! -z "$PID" ]; then
        echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É 80 (PID: $PID). –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é."
    fi
else
    echo "‚úÖ –ü–æ—Ä—Ç 80 —Å–≤–æ–±–æ–¥–µ–Ω"
fi
echo ""

# –®–∞–≥ 4: –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
echo "4Ô∏è‚É£ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ Git..."
git pull origin main
echo ""

# –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã
echo "5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤..."
if [ ! -f "nginx.conf" ]; then
    echo "‚ùå nginx.conf –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi
if [ ! -f "index.html" ]; then
    echo "‚ùå index.html –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi
echo "‚úÖ –§–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ"
echo ""

# –®–∞–≥ 6: –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
echo "6Ô∏è‚É£ –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
docker compose build --no-cache
echo ""

# –®–∞–≥ 7: –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
echo "7Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
docker compose up -d
echo ""

# –®–∞–≥ 8: –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
echo "8Ô∏è‚É£ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (10 —Å–µ–∫—É–Ω–¥)..."
sleep 10
echo ""

# –®–∞–≥ 9: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "9Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
docker compose ps
echo ""

# –®–∞–≥ 10: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏
echo "üîü –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
docker compose logs --tail=20 web
echo ""

# –®–∞–≥ 11: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx
echo "1Ô∏è‚É£1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx:"
if docker ps | grep -q novolunie-web; then
    docker compose exec web nginx -t
    if [ $? -eq 0 ]; then
        echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
        echo "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
        docker compose exec web nginx -s reload
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx"
    fi
else
    echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
fi
echo ""

# –®–∞–≥ 12: –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
echo "1Ô∏è‚É£2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:"
echo "–û–∂–∏–¥–∞–Ω–∏–µ –µ—â–µ 5 —Å–µ–∫—É–Ω–¥..."
sleep 5

HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost 2>&1)
echo "HTTP –∫–æ–¥ localhost: $HTTP_CODE"

if [ "$HTTP_CODE" = "200" ]; then
    echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ!"
elif [ "$HTTP_CODE" = "503" ]; then
    echo "‚ùå –í—Å–µ –µ—â–µ –æ—à–∏–±–∫–∞ 503"
    echo ""
    echo "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:"
    echo "  docker compose logs -f web"
    echo "  docker compose exec web ps aux"
    echo "  docker compose exec web nginx -t"
else
    echo "‚ö†Ô∏è  –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –∫–æ–¥: $HTTP_CODE"
fi
echo ""

# –®–∞–≥ 13: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
echo "1Ô∏è‚É£3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞:"
echo "–ü–æ—Ä—Ç 80:"
sudo netstat -tulpn | grep :80 || sudo ss -tulpn | grep :80 || echo "‚ö†Ô∏è  –ü–æ—Ä—Ç 80 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è"
echo ""

echo "================================="
echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç:"
echo "  http://e-novolunie.ru"
echo "  http://85.239.44.197"
echo ""
echo "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤:"
echo "  docker compose logs -f web"
echo ""
echo "–î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:"
echo "  ./diagnose-503.sh"
