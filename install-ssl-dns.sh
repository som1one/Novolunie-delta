#!/bin/bash

echo "üîí –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —á–µ—Ä–µ–∑ DNS challenge"
echo "=================================================="
echo ""
echo "–≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –ù–ï —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è A-–∑–∞–ø–∏—Å–∏"
echo "–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ —Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–æ–º."
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –æ—Ç root –∏–ª–∏ —Å sudo
if [ "$EUID" -ne 0 ]; then 
    echo "‚ö†Ô∏è  –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å sudo:"
    echo "   sudo ./install-ssl-dns.sh"
    exit 1
fi

echo "1Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ certbot (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)..."
echo "----------------------------------------"
if ! command -v certbot &> /dev/null; then
    apt update
    apt install certbot -y
    echo "‚úÖ Certbot —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    echo "‚úÖ Certbot —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi
echo ""

echo "2Ô∏è‚É£ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ DNS challenge..."
echo "----------------------------------------"
echo ""
echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: Certbot –ø–æ–ø—Ä–æ—Å–∏—Ç –¥–æ–±–∞–≤–∏—Ç—å TXT –∑–∞–ø–∏—Å–∏ –≤ DNS."
echo "   –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –ø–æ–¥–æ–∂–¥–∏—Ç–µ 2-5 –º–∏–Ω—É—Ç"
echo "   –∏ –Ω–∞–∂–º–∏—Ç–µ Enter –≤ certbot."
echo ""

read -p "–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞): " EMAIL

if [ -z "$EMAIL" ]; then
    certbot certonly --manual --preferred-challenges dns \
      -d e-novolunie.ru -d www.e-novolunie.ru \
      --register-unsafely-without-email --agree-tos
else
    certbot certonly --manual --preferred-challenges dns \
      -d e-novolunie.ru -d www.e-novolunie.ru \
      --email "$EMAIL" --agree-tos
fi

if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
    echo ""
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "  1. TXT –∑–∞–ø–∏—Å–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ DNS"
    echo "  2. –ù–µ –ø—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è DNS"
    echo "  3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è TXT –∑–∞–ø–∏—Å–µ–π"
    echo ""
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:"
    echo "  sudo ./install-ssl-dns.sh"
    exit 1
fi

echo ""
echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã!"
CERT_PATH="/etc/letsencrypt/live/e-novolunie.ru"

echo ""
echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
echo "----------------------------------------"
if [ -f "$CERT_PATH/fullchain.pem" ] && [ -f "$CERT_PATH/privkey.pem" ]; then
    echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–∞–π–¥–µ–Ω—ã:"
    ls -lh "$CERT_PATH/"
else
    echo "‚ùå –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ $CERT_PATH"
    exit 1
fi
echo ""

echo "4Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx —Å HTTPS..."
echo "----------------------------------------"

# –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è webroot (–¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤)
mkdir -p /var/www/certbot

# –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx
cat > /etc/nginx/sites-available/e-novolunie.ru << 'EOF'
# HTTP —Å–µ—Ä–≤–µ—Ä - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name e-novolunie.ru www.e-novolunie.ru;

    # –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ ACME challenge –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
    }

    # –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS —Å–µ—Ä–≤–µ—Ä
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name e-novolunie.ru www.e-novolunie.ru;

    # SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
    ssl_certificate /etc/letsencrypt/live/e-novolunie.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/e-novolunie.ru/privkey.pem;

    # SSL –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # –ö–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–∞–π—Ç–∞
    root /var/www/html;
    index index.html;

    # –õ–æ–≥–∏
    access_log /var/log/nginx/e-novolunie.ru.access.log;
    error_log /var/log/nginx/e-novolunie.ru.error.log;

    # –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    location / {
        try_files $uri $uri/ /index.html;
    }

    # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Gzip —Å–∂–∞—Ç–∏–µ
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    error_page 404 /index.html;
    error_page 500 502 503 504 /index.html;

    server_tokens off;
    client_max_body_size 10M;
}
EOF

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
ln -sf /etc/nginx/sites-available/e-novolunie.ru /etc/nginx/sites-enabled/

# –£–¥–∞–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (–µ—Å–ª–∏ –µ—Å—Ç—å)
rm -f /etc/nginx/sites-enabled/default

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo ""
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
if nginx -t; then
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx"
    exit 1
fi

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã —Å–∞–π—Ç–∞
echo ""
echo "5Ô∏è‚É£ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —Å–∞–π—Ç–∞..."
echo "----------------------------------------"
if [ -d "/root/novolunie" ]; then
    SITE_DIR="/root/novolunie"
elif [ -d "$HOME/novolunie" ]; then
    SITE_DIR="$HOME/novolunie"
else
    echo "‚ö†Ô∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è novolunie –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    echo "   –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã —Å–∞–π—Ç–∞ –≤—Ä—É—á–Ω—É—é –≤ /var/www/html/"
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è? (y/n) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

if [ -n "$SITE_DIR" ]; then
    mkdir -p /var/www/html
    cp -r "$SITE_DIR"/* /var/www/html/ 2>/dev/null || true
    # –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —Ñ–∞–π–ª—ã
    rm -f /var/www/html/*.sh /var/www/html/*.md /var/www/html/.git* 2>/dev/null || true
    chown -R www-data:www-data /var/www/html
    echo "‚úÖ –§–∞–π–ª—ã —Å–∞–π—Ç–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
fi

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç—ã
echo ""
echo "6Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞..."
echo "----------------------------------------"
if command -v ufw &> /dev/null; then
    ufw allow 80/tcp
    ufw allow 443/tcp
    echo "‚úÖ –ü–æ—Ä—Ç—ã 80 –∏ 443 –æ—Ç–∫—Ä—ã—Ç—ã"
else
    echo "‚ö†Ô∏è  UFW –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π—Ä–≤–æ–ª –≤—Ä—É—á–Ω—É—é"
fi

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx
echo ""
echo "7Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx..."
echo "----------------------------------------"
systemctl reload nginx

if [ $? -eq 0 ]; then
    echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ Nginx"
    systemctl status nginx
    exit 1
fi

echo ""
echo "=========================================="
echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
echo "=========================================="
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É HTTPS:"
echo "  curl -I https://e-novolunie.ru"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç:"
echo "  openssl s_client -connect e-novolunie.ru:443 -servername e-novolunie.ru < /dev/null"
echo ""
echo "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:"
echo "  sudo certbot renew --dry-run"
echo ""
